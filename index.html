import { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from 'firebase/auth';
import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs } from 'firebase/firestore';

const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// Ngôn ngữ mặc định
const translations = {
  vi: {
    platformTitle: "DistriHub",
    platformSubtitle: "Kết nối đối tác, Phát triển kinh doanh",
    homeBrandTitle: "Kết nối với Nhà Phân Phối tiềm năng",
    homeBrandDescription: "Nền tảng giúp bạn tìm kiếm và so sánh các NPP phù hợp nhất với sản phẩm của mình, dựa trên các tiêu chí cụ thể.",
    homeNPPTitle: "Tìm kiếm Thương hiệu uy tín",
    homeNPPDescription: "Khám phá các thương hiệu mới và mở rộng danh mục sản phẩm của bạn, với công cụ phân tích chuyên sâu.",
    loginButton: "Đăng nhập",
    logoutButton: "Đăng xuất",
    welcomeTitle: "Chào mừng, ",
    publicView: "Chế độ xem công khai",
    authenticatedView: "Bạn đã đăng nhập",
    profileTitle: "Hồ sơ của bạn",
    searchPlaceholder: "Tìm kiếm đối tác...",
    language: "Ngôn ngữ:",
    vietnamese: "Tiếng Việt",
    english: "Tiếng Anh",
    roleAdmin: "Admin",
    roleBrand: "Brand",
    roleNPP: "NPP",
    loginHeader: "Đăng nhập vào DistriHub",
    registerHeader: "Đăng ký tài khoản",
    emailLabel: "Email",
    passwordLabel: "Mật khẩu",
    roleLabel: "Vai trò",
    loginAction: "Đăng nhập",
    registerAction: "Đăng ký",
    orLoginWith: "Hoặc đăng nhập với",
    orRegisterWith: "Hoặc đăng ký với",
    loginWithGoogle: "Đăng nhập với Google",
    loginWithFacebook: "Đăng nhập với Facebook",
    noAccount: "Chưa có tài khoản?",
    haveAccount: "Đã có tài khoản?",
    errorRegister: "Đăng ký thất bại: ",
    errorLogin: "Đăng nhập thất bại: ",
    modalClose: "Đóng",
    profileFormTitle: "Hoàn thiện hồ sơ của bạn",
    profileFormSubtitle: "Vui lòng cung cấp thông tin chi tiết để đối tác dễ dàng tìm thấy bạn.",
    profileName: "Tên công ty/thương hiệu",
    profileContact: "Thông tin liên hệ",
    profileDescription: "Mô tả ngắn gọn",
    profileAddress: "Địa chỉ trụ sở chính",
    profileWebsite: "Website",
    profileProductCategory: "Ngành hàng sản phẩm",
    profileMarkets: "Thị trường hoạt động",
    profileSave: "Lưu hồ sơ",
    partnerListNPPTitle: "Danh sách Nhà Phân Phối",
    partnerListBrandTitle: "Danh sách Thương hiệu",
    noPartners: "Chưa có đối tác nào được phê duyệt.",
    viewProfile: "Xem hồ sơ",
    backToList: "Quay lại danh sách",
    companySize: "Quy mô",
    marketCoverage: "Độ phủ thị trường",
    employees: "Số nhân viên",
    annualRevenue: "Doanh thu hàng năm",
    kpi: "Các chỉ số KPI",
    operation: "Vận hành",
    tradeMarketing: "Trade Marketing",
    marketing: "Marketing",
    financial: "Tài chính",
    reporting: "Hệ thống báo cáo",
    storesLast3Months: "Số cửa hàng hoạt động (3 tháng gần nhất)",
    salesmanRatio: "Số cửa hàng/Salesman",
    callsPerDay: "Số cuộc gọi hoàn thành/ngày",
    successfulCallRate: "Tỷ lệ cuộc gọi thành công",
    ordersPerCall: "Số hóa đơn/cuộc gọi",
    inventoryAccuracy: "Tỷ lệ chính xác tồn kho",
    promotionsOnTime: "Tỷ lệ chạy khuyến mãi đúng hạn",
    salesForceSupport: "Hỗ trợ đội ngũ Sales",
    brandCampaignParticipation: "Tỷ lệ tham gia chiến dịch Brand",
    digitalFootprint: "Dấu ấn số",
    socialMediaEngagement: "Tỷ lệ tương tác mạng xã hội",
    adCampaignROI: "ROI chiến dịch quảng cáo",
    revenueGrowth: "Tăng trưởng doanh thu",
    profitMargin: "Biên lợi nhuận ròng",
    paymentTime: "Thời gian thanh toán trung bình",
    reportingSystem: "Hệ thống báo cáo",
    compareButton: "So sánh",
    requestAccessButton: "Yêu cầu quyền truy cập thông tin bảo mật",
    accessPending: "Yêu cầu đang chờ phê duyệt...",
    accessGranted: "Đã có quyền truy cập!",
    confidentialInfo: "Thông tin bảo mật",
    selectedForComparison: "Đã chọn để so sánh",
    comparisonTitle: "So sánh các Nhà Phân Phối",
    backToComparison: "Quay lại trang so sánh",
    clearComparison: "Xóa danh sách so sánh",
    startComparison: "Bắt đầu so sánh",
    notLoggedInMessage: "Vui lòng đăng nhập để xem thông tin chi tiết và so sánh.",
    adminDashboard: "Bảng điều khiển Admin",
    pendingProfiles: "Hồ sơ đang chờ duyệt",
    approvedProfiles: "Hồ sơ đã duyệt",
    approveButton: "Phê duyệt",
    rejectButton: "Từ chối",
    noPendingProfiles: "Không có hồ sơ nào đang chờ duyệt.",
    profileStatus: "Trạng thái",
    statusPending: "Đang chờ",
    statusApproved: "Đã duyệt",
    statusRejected: "Đã từ chối",
    // New translations for NPP profile framework
    nppExecutiveSummary: "1. Khái quát nhanh",
    nppIntegratedService: "2. Mô hình dịch vụ",
    nppPartnershipModel: "3. Kênh phân phối, mô hình hợp tác & chi phí",
    nppIndustryExperience: "4. Kinh nghiệm ngành, uy tín & minh chứng",
    nppCooperationCommitment: "5. Cam kết hợp tác & rủi ro pháp lý",
    nppKpiManagement: "6. KPI & Quản trị hiệu suất",
    distriNetwork: "Mạng lưới phân phối",
    staffCount: "Số lượng nhân sự",
    coverageArea: "Vùng phủ",
    businessUnits: "Đơn vị kinh doanh",
    establishedYear: "Năm thành lập",
    outstandingCapacity: "Năng lực nổi bật",
    uniqueSellingPoints: "Điểm khác biệt & thế mạnh",
    importCompliance: "Nhập khẩu & tuân thủ",
    distributionLogistics: "Phân phối & logistics",
    salesTrade: "Bán hàng & thương mại",
    marketingBranding: "Marketing & thương hiệu",
    afterSalesSupport: "Hậu mãi & chăm sóc khách hàng",
    techSupport: "Công nghệ hỗ trợ",
    scope: "Phạm vi phân phối",
    moqFulfillment: "MOQ & Fulfillment",
    costTerms: "Chi phí & điều khoản thương mại",
    paymentTerms: "Điều khoản thanh toán",
    marketingSupport: "Hỗ trợ marketing",
    afterSalesPolicy: "Chính sách hậu mãi & bảo hành",
    keyClients: "Khách hàng & dự án tiêu biểu",
    achievements: "Thành tựu & uy tín",
    awards: "Giải thưởng",
    certifications: "Chứng nhận",
    esg: "Trách nhiệm cộng đồng",
    cooperationPolicy: "Chính sách hợp tác",
    legalTerms: "Điều khoản pháp lý",
    riskManagement: "Quản lý rủi ro",
    insurance: "Bảo hiểm & trách nhiệm",
    // KPIs
    avgCustomsClearance: "Thời gian thông quan trung bình",
    complianceRate: "Tỷ lệ lô hàng đạt chuẩn",
    kpiOnTimeDelivery: "Tỷ lệ giao hàng đúng hạn",
    fillRate: "Tỷ lệ fill-rate (đáp ứng đơn hàng)",
    logisticsCostPerRevenue: "Chi phí logistics/doanh thu",
    monthlySales: "Doanh số hàng tháng",
    newOutlets: "Số điểm bán mới",
    marketShare: "Thị phần",
    activationsCount: "Số activation triển khai",
    coMarketingROI: "ROI từ co-marketing",
    sla: "SLA xử lý khiếu nại",
    nps: "Net Promoter Score (NPS)",
    realTimeDashboard: "Dashboard real-time",
    scorecard: "Scorecard đánh giá định kỳ",
  },
  en: {
    platformTitle: "DistriHub",
    platformSubtitle: "Connect Partners, Grow Business",
    homeBrandTitle: "Connect with Potential Distributors",
    homeBrandDescription: "The platform helps you find and compare the most suitable NPPs for your products, based on specific criteria.",
    homeNPPTitle: "Discover Reputable Brands",
    homeNPPDescription: "Explore new brands and expand your product portfolio with in-depth analytics tools.",
    loginButton: "Login",
    logoutButton: "Logout",
    welcomeTitle: "Welcome, ",
    publicView: "Public View",
    authenticatedView: "You are logged in",
    profileTitle: "Your Profile",
    searchPlaceholder: "Search for partners...",
    language: "Language:",
    vietnamese: "Vietnamese",
    english: "English",
    roleAdmin: "Admin",
    roleBrand: "Brand",
    roleNPP: "NPP",
    loginHeader: "Login to DistriHub",
    registerHeader: "Create an account",
    emailLabel: "Email",
    passwordLabel: "Password",
    roleLabel: "Role",
    loginAction: "Login",
    registerAction: "Register",
    orLoginWith: "Or login with",
    orRegisterWith: "Or register with",
    loginWithGoogle: "Login with Google",
    loginWithFacebook: "Login with Facebook",
    noAccount: "Don't have an account?",
    haveAccount: "Already have an account?",
    errorRegister: "Registration failed: ",
    errorLogin: "Login failed: ",
    modalClose: "Close",
    profileFormTitle: "Complete Your Profile",
    profileFormSubtitle: "Please provide detailed information so partners can easily find you.",
    profileName: "Company/Brand Name",
    profileContact: "Contact Information",
    profileDescription: "Brief Description",
    profileAddress: "Headquarters Address",
    profileWebsite: "Website",
    profileProductCategory: "Product Category",
    profileMarkets: "Operating Markets",
    profileSave: "Save Profile",
    partnerListNPPTitle: "Distributor List",
    partnerListBrandTitle: "Brand List",
    noPartners: "No approved partners found.",
    viewProfile: "View Profile",
    backToList: "Back to list",
    companySize: "Company Size",
    marketCoverage: "Market Coverage",
    employees: "Employees",
    annualRevenue: "Annual Revenue",
    kpi: "Các chỉ số KPI",
    operation: "Operations",
    tradeMarketing: "Trade Marketing",
    marketing: "Marketing",
    financial: "Financial",
    reporting: "Reporting System",
    storesLast3Months: "Active Stores (last 3 months)",
    salesmanRatio: "Stores/Salesman Ratio",
    callsPerDay: "Calls Completed/Day",
    successfulCallRate: "Successful Call Rate",
    ordersPerCall: "Orders/Call",
    inventoryAccuracy: "Inventory Accuracy",
    promotionsOnTime: "On-time Promo Execution Rate",
    salesForceSupport: "Sales Force Support",
    brandCampaignParticipation: "Brand Campaign Participation",
    digitalFootprint: "Digital Footprint",
    socialMediaEngagement: "Social Media Engagement Rate",
    adCampaignROI: "Ad Campaign ROI",
    revenueGrowth: "Revenue Growth",
    profitMargin: "Net Profit Margin",
    paymentTime: "Avg. Payment Time",
    reportingSystem: "Reporting System",
    compareButton: "Compare",
    requestAccessButton: "Request Confidential Access",
    accessPending: "Request pending approval...",
    accessGranted: "Access granted!",
    confidentialInfo: "Confidential Information",
    selectedForComparison: "Selected for comparison",
    comparisonTitle: "Distributor Comparison",
    backToComparison: "Back to comparison",
    clearComparison: "Clear comparison list",
    startComparison: "Start comparison",
    notLoggedInMessage: "Please log in to view detailed information and compare.",
    adminDashboard: "Admin Dashboard",
    pendingProfiles: "Pending Profiles",
    approvedProfiles: "Approved Profiles",
    approveButton: "Approve",
    rejectButton: "Reject",
    noPendingProfiles: "No profiles are pending approval.",
    profileStatus: "Status",
    statusPending: "Pending",
    statusApproved: "Approved",
    statusRejected: "Rejected",
    // New translations for NPP profile framework
    nppExecutiveSummary: "1. Executive Summary",
    nppIntegratedService: "2. Integrated Service Offering",
    nppPartnershipModel: "3. Distribution Channels, Partnership Model & Costs",
    nppIndustryExperience: "4. Industry Experience, Credibility & Proof",
    nppCooperationCommitment: "5. Cooperation Commitment & Legal Risks",
    nppKpiManagement: "6. KPIs & Performance Management",
    distriNetwork: "Distribution Network",
    staffCount: "Number of Personnel",
    coverageArea: "Coverage Area",
    businessUnits: "Business Units",
    establishedYear: "Year Established",
    outstandingCapacity: "Outstanding Capability",
    uniqueSellingPoints: "Differentiators & Strengths",
    importCompliance: "Import & Compliance",
    distributionLogistics: "Distribution & Logistics",
    salesTrade: "Sales & Trade",
    marketingBranding: "Marketing & Branding",
    afterSalesSupport: "After-Sales & Customer Care",
    techSupport: "Technology Support",
    scope: "Distribution Scope",
    moqFulfillment: "MOQ & Fulfillment",
    costTerms: "Costs & Commercial Terms",
    paymentTerms: "Payment Terms",
    marketingSupport: "Marketing Support",
    afterSalesPolicy: "After-Sales & Warranty Policy",
    keyClients: "Key Clients & Projects",
    achievements: "Achievements & Credibility",
    awards: "Awards",
    certifications: "Certifications",
    esg: "Community Responsibility",
    cooperationPolicy: "Cooperation Policy",
    legalTerms: "Legal Terms",
    riskManagement: "Risk Management",
    insurance: "Insurance & Liability",
    // KPIs
    avgCustomsClearance: "Avg. Customs Clearance Time",
    complianceRate: "Compliance Rate",
    kpiOnTimeDelivery: "On-time Delivery Rate",
    fillRate: "Fill-rate",
    logisticsCostPerRevenue: "Logistics Cost/Revenue",
    monthlySales: "Monthly Sales",
    newOutlets: "New Outlets",
    marketShare: "Market Share",
    activationsCount: "Activations Count",
    coMarketingROI: "Co-marketing ROI",
    sla: "SLA for Complaint Handling",
    nps: "Net Promoter Score (NPS)",
    realTimeDashboard: "Real-time Dashboard",
    scorecard: "Scorecard",
  }
};

const getMockPartnersData = () => {
  return [
    {
      id: "npp1",
      role: "npp",
      name: "Công Ty Phân Phối DTH",
      description: "NPP chuyên sâu, tích hợp toàn diện chuỗi cung ứng cho các thương hiệu hàng đầu Việt Nam và khu vực.",
      contact: "dth@example.com",
      address: "Hà Nội, Việt Nam",
      website: "https://dth-distri.com",
      productCategory: "FMCG, Mỹ phẩm, Chăm sóc sức khỏe",
      markets: "Toàn quốc & Campuchia",
      status: "approved",
      nppProfile: {
        executiveSummary: {
          name: "Công ty Phân phối DTH",
          logo: "https://placehold.co/128x128/2563EB/ffffff?text=DH",
          establishedYear: "2005",
          businessUnits: "4 đơn vị: FMCG, HealthCare, Beauty, E-commerce.",
          coverageArea: "Toàn quốc và Campuchia.",
          staffCount: "1200 nhân sự",
          outstandingCapacity: "Phục vụ 10.000+ cửa hàng, chuyên về FMCG & Dược phẩm.",
          uniqueSellingPoints: "Chuỗi giá trị tích hợp, công nghệ vận hành hiện đại."
        },
        integratedService: {
          importCompliance: "Thủ tục hải quan, giấy phép & kiểm nghiệm chất lượng sản phẩm.",
          distributionLogistics: "Hệ thống kho bãi 5000m2, đội xe 100+ chiếc, quản lý tồn kho WMS & RFID.",
          salesTrade: "Đội ngũ sales chuyên nghiệp, quan hệ mạnh với kênh GT/MT/Online.",
          marketingBranding: "Hỗ trợ POSM, activation, digital ads, co-marketing.",
          afterSalesSupport: "Quy trình xử lý đổi trả, hàng lỗi, bảo hành.",
          techSupport: "Nền tảng báo cáo real-time, SOP số hóa, visibility platform."
        },
        partnershipModel: {
          scope: "Phủ sóng 63 tỉnh/thành phố, độ sâu mạng lưới tại các khu vực trọng điểm.",
          moqFulfillment: "Mức đặt hàng tối thiểu, thời gian và quy trình giao nhận.",
          costTerms: "Giá gốc, giá đề xuất bán lẻ, và các chiết khấu, lợi nhuận biên.",
          paymentTerms: "Điều kiện thanh toán: Net 30/60 ngày, phí phạt trễ hạn.",
          marketingSupport: "Hỗ trợ POSM, guideline, ngân sách co-marketing.",
          afterSalesPolicy: "Điều kiện đổi trả, xử lý hàng lỗi, thời gian bảo hành.",
        },
        industryExperience: {
          keyClients: ["Unilever", "P&G", "Nestlé", "L'Oréal"],
          achievements: [
            "Tăng thị phần 15% cho thương hiệu X trong 1 năm.",
            "Đạt tốc độ ra mắt sản phẩm mới (speed-to-market) nhanh nhất thị trường.",
          ],
        },
        credibility: {
          awards: ["Top 500 Doanh nghiệp lớn nhất VN", "Giải thưởng Vàng Chất lượng dịch vụ"],
          certifications: ["ISO 9001:2015", "GSP"],
          esg: "Chương trình 'Phân phối xanh' giảm thiểu rác thải nhựa."
        },
      },
      confidential: {
        legalCommitment: {
          cooperationPolicy: "Không phân phối sản phẩm cạnh tranh, cam kết mở rộng thị trường.",
          legalTerms: "Điều khoản chấm dứt hợp đồng, giải quyết tranh chấp, bảo hộ IP.",
          riskManagement: "Kế hoạch dự phòng (backup stock, giải pháp khi soft launch thất bại).",
          insurance: "Bảo hiểm trách nhiệm trong lưu thông & phân phối.",
        },
        financialAndKpis: {
          financialStability: "Báo cáo tài chính 2023 - 2024. Đánh giá tín dụng A+ bởi VinaCapital.",
          kpis: {
            importCompliance: {
              avgCustomsClearance: "24 giờ",
              complianceRate: "99%",
            },
            logisticsDistribution: {
              onTimeDelivery: "98.5%",
              fillRate: "99%",
              logisticsCostPerRevenue: "<3%",
            },
            salesCoverage: {
              monthlySales: "200 tỷ VND/tháng",
              newOutlets: "100 điểm bán mới/tháng",
              marketShare: "40% (trong phân khúc FMCG tại HN & HCM)",
            },
            marketingBranding: {
              activationsCount: "20 activations/tháng",
              coMarketingROI: "2.5x",
            },
            customerService: {
              sla: "24 giờ",
              nps: "8.5/10",
            },
            management: {
              realTimeDashboard: "Có",
              scorecard: "Có",
              regularReports: "Báo cáo hàng tuần/tháng",
            },
          },
        },
      },
    },
    {
      id: "brand1",
      role: "brand",
      name: "Thương Hiệu X",
      description: "Thương hiệu mỹ phẩm tự nhiên cao cấp, sản xuất theo công nghệ Hàn Quốc.",
      contact: "brandx@example.com",
      address: "Hà Nội, Việt Nam",
      website: "https://brandx.com",
      productCategory: "Mỹ phẩm",
      markets: "Toàn quốc",
      status: "approved",
      companySize: "Doanh nghiệp vừa",
      employees: 100,
      annualRevenue: "200-300 tỷ VND",
      marketCoverage: "50 tỉnh/thành phố",
      confidential: {
        pricing: "Chính sách giá độc quyền cho NPP. Lợi nhuận biên 30-40%.",
        productFormulas: "Công thức sản phẩm độc quyền với chiết xuất tự nhiên 100%.",
        customerList: "Danh sách 200 khách hàng lớn (chuỗi siêu thị, nhà thuốc) và lịch sử giao dịch.",
        expansionPlan: "Kế hoạch mở rộng thị trường sang Đông Nam Á trong 3 năm tới.",
      },
    },
    {
        id: "npp-pending-1",
        role: "npp",
        name: "NPP Tạm đang chờ duyệt",
        description: "Hồ sơ đang chờ duyệt.",
        contact: "pending2@example.com",
        status: "pending",
        companySize: "Doanh nghiệp nhỏ",
        employees: 20,
        annualRevenue: "5-20 tỷ VND",
        marketCoverage: "2 tỉnh/thành phố",
        nppProfile: {
          executiveSummary: {
            name: "NPP Tạm đang chờ duyệt",
            logo: "https://placehold.co/128x128/f0f0f0/808080?text=DH",
            establishedYear: "2023",
            businessUnits: "1 đơn vị: Phân phối đa kênh",
            coverageArea: "Hà Nội",
            staffCount: "20 nhân sự",
            outstandingCapacity: "Phục vụ 500+ cửa hàng.",
            uniqueSellingPoints: "Tốc độ ra quyết định nhanh."
          },
          integratedService: {},
          partnershipModel: {},
          industryExperience: {},
          credibility: {},
        },
        confidential: {
          legalCommitment: {},
          financialAndKpis: {
            financialStability: "Chưa cung cấp",
            kpis: {
              importCompliance: {},
              logisticsDistribution: {},
              salesCoverage: {},
              marketingBranding: {},
              customerService: {},
              management: {},
            },
          },
        },
    },
    {
        id: "brand-pending-1",
        role: "brand",
        name: "Thương Hiệu Tạm đang chờ duyệt",
        description: "Hồ sơ đang chờ duyệt.",
        contact: "pending1@example.com",
        status: "pending",
        companySize: "Doanh nghiệp nhỏ",
        employees: 10,
        annualRevenue: "1-10 tỷ VND",
        marketCoverage: "5 tỉnh/thành phố",
        confidential: {
            pricing: "Chưa cung cấp",
            productFormulas: "Chưa cung cấp",
            customerList: "Chưa cung cấp",
            expansionPlan: "Chưa cung cấp",
        },
    },
  ];
};

const LoginModal = ({ t, onLogin, onClose, onSwitchToRegister }) => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState(null);
  const [loading, setLoading] = useState(false);

  const handleLogin = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError(null);
    try {
      await onLogin(email, password);
    } catch (err) {
      setError(t('errorLogin') + err.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
      <div className="relative bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600">&times;</button>
        <h2 className="text-2xl font-bold text-center mb-6 text-blue-800">{t('loginHeader')}</h2>
        {error && <div className="p-3 mb-4 bg-red-100 text-red-600 rounded-lg">{error}</div>}
        <form onSubmit={handleLogin}>
          <div className="mb-4">
            <label className="block text-gray-700 font-semibold mb-2">{t('emailLabel')}</label>
            <input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
          </div>
          <div className="mb-6">
            <label className="block text-gray-700 font-semibold mb-2">{t('passwordLabel')}</label>
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
          </div>
          <button
            type="submit"
            className="w-full bg-blue-600 text-white font-bold py-3 rounded-full hover:bg-blue-700 transition-colors duration-200"
            disabled={loading}
          >
            {loading ? "..." : t('loginAction')}
          </button>
        </form>
        <div className="text-center mt-6">
          <p className="text-sm text-gray-500">{t('noAccount')} <button onClick={onSwitchToRegister} className="text-blue-600 font-semibold">{t('registerAction')}</button></p>
        </div>
      </div>
    </div>
  );
};

const RegisterModal = ({ t, onRegister, onClose, onSwitchToLogin }) => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [role, setRole] = useState('brand');
  const [error, setError] = useState(null);
  const [loading, setLoading] = useState(false);

  const handleRegister = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError(null);
    try {
      await onRegister(email, password, role);
    } catch (err) {
      setError(t('errorRegister') + err.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
      <div className="relative bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600">&times;</button>
        <h2 className="text-2xl font-bold text-center mb-6 text-blue-800">{t('registerHeader')}</h2>
        {error && <div className="p-3 mb-4 bg-red-100 text-red-600 rounded-lg">{error}</div>}
        <form onSubmit={handleRegister}>
          <div className="mb-4">
            <label className="block text-gray-700 font-semibold mb-2">{t('emailLabel')}</label>
            <input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
          </div>
          <div className="mb-4">
            <label className="block text-gray-700 font-semibold mb-2">{t('passwordLabel')}</label>
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
          </div>
          <div className="mb-6">
            <label className="block text-gray-700 font-semibold mb-2">{t('roleLabel')}</label>
            <select
              value={role}
              onChange={(e) => setRole(e.target.value)}
              className="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="brand">{t('roleBrand')}</option>
              <option value="npp">{t('roleNPP')}</option>
            </select>
          </div>
          <button
            type="submit"
            className="w-full bg-blue-600 text-white font-bold py-3 rounded-full hover:bg-blue-700 transition-colors duration-200"
            disabled={loading}
          >
            {loading ? "..." : t('registerAction')}
          </button>
        </form>
        <div className="text-center mt-6">
          <p className="text-sm text-gray-500">{t('haveAccount')} <button onClick={onSwitchToLogin} className="text-blue-600 font-semibold">{t('loginAction')}</button></p>
        </div>
      </div>
    </div>
  );
};

const ProfileForm = ({ t, db, user, userRole, onSave }) => {
  const [profileName, setProfileName] = useState('');
  const [profileContact, setProfileContact] = useState('');
  const [profileDescription, setProfileDescription] = useState('');
  const [profileAddress, setProfileAddress] = useState('');
  const [profileWebsite, setProfileWebsite] = useState('');
  const [profileProductCategory, setProfileProductCategory] = useState('');
  const [profileMarkets, setProfileMarkets] = useState('');
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    const profileData = {
      role: userRole,
      name: profileName,
      contact: profileContact,
      description: profileDescription,
      address: profileAddress,
      website: profileWebsite,
      productCategory: profileProductCategory,
      markets: profileMarkets,
      status: 'pending', // Trạng thái ban đầu: chờ admin duyệt
      createdAt: new Date(),
    };
    await onSave(profileData);
    setLoading(false);
  };

  return (
    <div className="max-w-3xl mx-auto p-8 bg-white rounded-2xl shadow-xl">
      <h2 className="text-3xl font-bold text-center mb-2 text-blue-800">{t('profileFormTitle')}</h2>
      <p className="text-center text-gray-600 mb-8">{t('profileFormSubtitle')}</p>
      <form onSubmit={handleSubmit} className="space-y-6">
        <div>
          <label className="block text-gray-700 font-semibold mb-2">{t('profileName')}</label>
          <input
            type="text"
            value={profileName}
            onChange={(e) => setProfileName(e.target.value)}
            className="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          />
        </div>
        <div>
          <label className="block text-gray-700 font-semibold mb-2">{t('profileContact')}</label>
          <input
            type="text"
            value={profileContact}
            onChange={(e) => setProfileContact(e.target.value)}
            className="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          />
        </div>
        <div>
          <label className="block text-gray-700 font-semibold mb-2">{t('profileDescription')}</label>
          <textarea
            value={profileDescription}
            onChange={(e) => setProfileDescription(e.target.value)}
            className="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
            rows="4"
            required
          />
        </div>
        <div>
          <label className="block text-gray-700 font-semibold mb-2">{t('profileAddress')}</label>
          <input
            type="text"
            value={profileAddress}
            onChange={(e) => setProfileAddress(e.target.value)}
            className="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          />
        </div>
        <div>
          <label className="block text-gray-700 font-semibold mb-2">{t('profileWebsite')}</label>
          <input
            type="url"
            value={profileWebsite}
            onChange={(e) => setProfileWebsite(e.target.value)}
            className="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <div>
          <label className="block text-gray-700 font-semibold mb-2">{t('profileProductCategory')}</label>
          <input
            type="text"
            value={profileProductCategory}
            onChange={(e) => setProfileProductCategory(e.target.value)}
            className="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          />
        </div>
        <div>
          <label className="block text-gray-700 font-semibold mb-2">{t('profileMarkets')}</label>
          <input
            type="text"
            value={profileMarkets}
            onChange={(e) => setProfileMarkets(e.target.value)}
            className="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          />
        </div>
        <button
          type="submit"
          className="w-full bg-blue-600 text-white font-bold py-3 rounded-full hover:bg-blue-700 transition-colors duration-200"
          disabled={loading}
        >
          {loading ? "..." : t('profileSave')}
        </button>
      </form>
    </div>
  );
};

const PartnerCard = ({ t, partner, onClick, onSelectForComparison }) => (
    <div className="cursor-pointer bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2">
      <div className="flex items-center mb-4" onClick={() => onClick(partner)}>
        {/* Placeholder image for a company logo */}
        <img src={partner.nppProfile.executiveSummary.logo} alt={`${partner.role} logo`} className="w-16 h-16 rounded-full mr-4" />
        <div>
          <h3 className="text-xl font-bold text-gray-800">{partner.name}</h3>
          <p className="text-sm text-blue-600 font-semibold">{partner.role === 'brand' ? t('roleBrand') : t('roleNPP')}</p>
        </div>
      </div>
      <p className="text-gray-600 text-sm mb-4 line-clamp-3">{partner.description}</p>
      {partner.nppProfile && (
        <div className="text-sm text-gray-700 mb-4 space-y-2">
            <h4 className="font-bold text-gray-800">Thông tin nổi bật</h4>
            <p><span className="font-semibold">{t('distriNetwork')}:</span> {partner.nppProfile.executiveSummary.distriNetwork}</p>
            <p><span className="font-semibold">{t('staffCount')}:</span> {partner.nppProfile.executiveSummary.staffCount}</p>
            <p><span className="font-semibold">{t('coverageArea')}:</span> {partner.nppProfile.executiveSummary.coverageArea}</p>
            <p><span className="font-semibold">Năng lực nổi bật:</span> {partner.nppProfile.executiveSummary.outstandingCapacity}</p>
        </div>
      )}
      <div className="flex items-center justify-between">
        <button onClick={() => onClick(partner)} className="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-700 transition-colors duration-200">
          {t('viewProfile')}
        </button>
        {partner.role === 'npp' && (
          <button 
            onClick={(e) => {
              e.stopPropagation();
              onSelectForComparison(partner);
            }}
            className="ml-2 bg-gray-200 text-gray-800 py-2 px-4 rounded-full font-bold hover:bg-gray-300 transition-colors duration-200"
          >
            {t('compareButton')}
          </button>
        )}
      </div>
    </div>
);

const PartnerList = ({ t, db, user, userRole, onSelectPartner, comparisonList, onSelectForComparison, onStartComparison }) => {
    const [partners, setPartners] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const fetchPartners = async () => {
            const mockData = getMockPartnersData();
            let filteredPartners = [];
            if (userRole === 'brand') {
                filteredPartners = mockData.filter(p => p.role === 'npp' && p.status === 'approved');
            } else if (userRole === 'npp') {
                filteredPartners = mockData.filter(p => p.role === 'brand' && p.status === 'approved');
            } else {
                filteredPartners = mockData.filter(p => p.status === 'approved');
            }
            
            setTimeout(() => {
                setPartners(filteredPartners);
                setLoading(false);
            }, 1000);
        };

        if (db && user) {
            fetchPartners();
        }
    }, [db, user, userRole]);

    if (loading) {
        return (
            <div className="flex items-center justify-center min-h-[300px] text-xl font-semibold text-gray-700">
                Đang tải danh sách đối tác...
            </div>
        );
    }

    const title = userRole === 'brand' ? t('partnerListNPPTitle') : t('partnerListBrandTitle');

    return (
        <div>
            <h1 className="text-4xl font-bold text-center mb-8 text-blue-800">{title}</h1>
            <div className="flex justify-between items-center mb-6 p-4 bg-white rounded-xl shadow-md">
                <span className="font-semibold text-gray-700">{t('selectedForComparison')}: {comparisonList.length}</span>
                <div className="space-x-2">
                  <button onClick={onStartComparison} className="bg-blue-600 text-white py-2 px-4 rounded-full text-sm font-bold hover:bg-blue-700 transition-colors duration-200" disabled={comparisonList.length < 2}>{t('startComparison')}</button>
                  <button onClick={() => onSelectForComparison(null, true)} className="bg-red-500 text-white py-2 px-4 rounded-full text-sm font-bold hover:bg-red-600 transition-colors duration-200">{t('clearComparison')}</button>
                </div>
            </div>
            {partners.length > 0 ? (
                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {partners.map(partner => (
                        <PartnerCard 
                          key={partner.id} 
                          t={t} 
                          partner={partner} 
                          onClick={onSelectPartner} 
                          onSelectForComparison={onSelectForComparison}
                        />
                    ))}
                </div>
            ) : (
                <div className="text-center text-lg text-gray-500">{t('noPartners')}</div>
            )}
        </div>
    );
};

const NPPDetailProfile = ({ t, partner }) => (
    <div className="space-y-8">
        {/* 1. Executive Summary */}
        <section className="bg-white p-6 rounded-xl shadow-md">
            <h3 className="text-2xl font-bold text-blue-800 mb-4">{t('nppExecutiveSummary')}</h3>
            <ul className="list-disc list-inside space-y-2 text-gray-700">
                <li><span className="font-semibold">Tên công ty:</span> {partner.nppProfile.executiveSummary.name}</li>
                <li><span className="font-semibold">Năm thành lập:</span> {partner.nppProfile.executiveSummary.establishedYear}</li>
                <li><span className="font-semibold">Quy mô:</span> {partner.nppProfile.executiveSummary.staffCount} nhân sự, {partner.nppProfile.executiveSummary.businessUnits} đơn vị kinh doanh.</li>
                <li><span className="font-semibold">Vùng phủ:</span> {partner.nppProfile.executiveSummary.coverageArea}</li>
                <li><span className="font-semibold">Năng lực nổi bật:</span> {partner.nppProfile.executiveSummary.outstandingCapacity}</li>
                <li><span className="font-semibold">Điểm khác biệt & thế mạnh:</span> {partner.nppProfile.executiveSummary.uniqueSellingPoints}</li>
            </ul>
        </section>

        {/* 2. Mô hình dịch vụ / Integrated Service Offering */}
        <section className="bg-white p-6 rounded-xl shadow-md">
            <h3 className="text-2xl font-bold text-blue-800 mb-4">{t('nppIntegratedService')}</h3>
            <ul className="list-disc list-inside space-y-2 text-gray-700">
                <li><span className="font-semibold">Nhập khẩu & tuân thủ:</span> {partner.nppProfile.integratedService.importCompliance}</li>
                <li><span className="font-semibold">Phân phối & logistics:</span> {partner.nppProfile.integratedService.distributionLogistics}</li>
                <li><span className="font-semibold">Bán hàng & thương mại:</span> {partner.nppProfile.integratedService.salesTrade}</li>
                <li><span className="font-semibold">Marketing & thương hiệu:</span> {partner.nppProfile.integratedService.marketingBranding}</li>
                <li><span className="font-semibold">Hậu mãi & chăm sóc khách hàng:</span> {partner.nppProfile.integratedService.afterSalesSupport}</li>
                <li><span className="font-semibold">Công nghệ hỗ trợ:</span> {partner.nppProfile.integratedService.techSupport}</li>
            </ul>
        </section>

        {/* 3. Kênh phân phối, mô hình hợp tác & chi phí */}
        <section className="bg-white p-6 rounded-xl shadow-md">
            <h3 className="text-2xl font-bold text-blue-800 mb-4">{t('nppPartnershipModel')}</h3>
            <ul className="list-disc list-inside space-y-2 text-gray-700">
                <li><span className="font-semibold">Phạm vi phân phối:</span> {partner.nppProfile.partnershipModel.scope}</li>
                <li><span className="font-semibold">MOQ & Fulfillment:</span> {partner.nppProfile.partnershipModel.moqFulfillment}</li>
                <li><span className="font-semibold">Chi phí & điều khoản thương mại:</span> {partner.nppProfile.partnershipModel.costTerms}</li>
                <li><span className="font-semibold">Điều khoản thanh toán:</span> {partner.nppProfile.partnershipModel.paymentTerms}</li>
                <li><span className="font-semibold">Hỗ trợ marketing & thương hiệu:</span> {partner.nppProfile.partnershipModel.marketingSupport}</li>
                <li><span className="font-semibold">Chính sách hậu mãi & bảo hành:</span> {partner.nppProfile.partnershipModel.afterSalesPolicy}</li>
            </ul>
        </section>

        {/* 4. Kinh nghiệm ngành, uy tín & minh chứng */}
        <section className="bg-white p-6 rounded-xl shadow-md">
            <h3 className="text-2xl font-bold text-blue-800 mb-4">{t('nppIndustryExperience')}</h3>
            <div className="space-y-2 mb-4">
                <p className="font-semibold text-gray-700">Khách hàng & dự án tiêu biểu:</p>
                <p className="text-gray-600">{partner.nppProfile.industryExperience.keyClients.join(', ')}</p>
            </div>
            <div className="space-y-2">
                <p className="font-semibold text-gray-700">Thành tựu & uy tín:</p>
                <ul className="list-disc list-inside space-y-2 text-gray-700">
                    {partner.nppProfile.industryExperience.achievements.map((achievement, index) => (
                        <li key={index}>{achievement}</li>
                    ))}
                    <li><span className="font-semibold">Giải thưởng:</span> {partner.nppProfile.credibility.awards.join(', ')}</li>
                    <li><span className="font-semibold">Chứng nhận:</span> {partner.nppProfile.credibility.certifications.join(', ')}</li>
                    <li><span className="font-semibold">Trách nhiệm cộng đồng:</span> {partner.nppProfile.credibility.esg}</li>
                </ul>
            </div>
        </section>

        {/* 5. Cam kết hợp tác & rủi ro pháp lý */}
        <section className="bg-white p-6 rounded-xl shadow-md">
            <h3 className="text-2xl font-bold text-blue-800 mb-4">{t('nppCooperationCommitment')}</h3>
            <ul className="list-disc list-inside space-y-2 text-gray-700">
                <li><span className="font-semibold">Chính sách hợp tác:</span> {partner.confidential.legalCommitment.cooperationPolicy}</li>
                <li><span className="font-semibold">Điều khoản pháp lý:</span> {partner.confidential.legalCommitment.legalTerms}</li>
                <li><span className="font-semibold">Quản lý rủi ro:</span> {partner.confidential.legalCommitment.riskManagement}</li>
                <li><span className="font-semibold">Bảo hiểm & trách nhiệm:</span> {partner.confidential.legalCommitment.insurance}</li>
            </ul>
        </section>

        {/* 6. KPI & Quản trị hiệu suất */}
        <section className="bg-white p-6 rounded-xl shadow-md">
            <h3 className="text-2xl font-bold text-blue-800 mb-4">{t('nppKpiManagement')}</h3>
            <div className="space-y-2">
                <p className="font-semibold text-gray-700">KPI về nhập khẩu & tuân thủ:</p>
                <ul className="list-disc list-inside space-y-1 text-gray-600">
                    <li><span className="font-semibold">Thời gian thông quan trung bình:</span> {partner.confidential.financialAndKpis.kpis.importCompliance.avgCustomsClearance}</li>
                    <li><span className="font-semibold">Tỷ lệ lô hàng đạt chuẩn:</span> {partner.confidential.financialAndKpis.kpis.importCompliance.complianceRate}</li>
                </ul>
            </div>
            <div className="space-y-2 mt-4">
                <p className="font-semibold text-gray-700">KPI về logistics & phân phối:</p>
                <ul className="list-disc list-inside space-y-1 text-gray-600">
                    <li><span className="font-semibold">Tỷ lệ giao hàng đúng hạn:</span> {partner.confidential.financialAndKpis.kpis.logisticsDistribution.kpiOnTimeDelivery}</li>
                    <li><span className="font-semibold">Tỷ lệ fill-rate:</span> {partner.confidential.financialAndKpis.kpis.logisticsDistribution.fillRate}</li>
                    <li><span className="font-semibold">Chi phí logistics/doanh thu:</span> {partner.confidential.financialAndKpis.kpis.logisticsDistribution.logisticsCostPerRevenue}</li>
                </ul>
            </div>
            <div className="space-y-2 mt-4">
                <p className="font-semibold text-gray-700">KPI về bán hàng & độ phủ:</p>
                <ul className="list-disc list-inside space-y-1 text-gray-600">
                    <li><span className="font-semibold">Doanh số hàng tháng:</span> {partner.confidential.financialAndKpis.kpis.salesCoverage.monthlySales}</li>
                    <li><span className="font-semibold">Số điểm bán mới:</span> {partner.confidential.financialAndKpis.kpis.salesCoverage.newOutlets}</li>
                    <li><span className="font-semibold">Thị phần:</span> {partner.confidential.financialAndKpis.kpis.salesCoverage.marketShare}</li>
                </ul>
            </div>
            <div className="space-y-2 mt-4">
                <p className="font-semibold text-gray-700">KPI về marketing & thương hiệu:</p>
                <ul className="list-disc list-inside space-y-1 text-gray-600">
                    <li><span className="font-semibold">Số activation triển khai:</span> {partner.confidential.financialAndKpis.kpis.marketingBranding.activationsCount}</li>
                    <li><span className="font-semibold">ROI co-marketing:</span> {partner.confidential.financialAndKpis.kpis.marketingBranding.coMarketingROI}</li>
                </ul>
            </div>
            <div className="space-y-2 mt-4">
                <p className="font-semibold text-gray-700">KPI về dịch vụ khách hàng & hậu mãi:</p>
                <ul className="list-disc list-inside space-y-1 text-gray-600">
                    <li><span className="font-semibold">SLA xử lý khiếu nại:</span> {partner.confidential.financialAndKpis.kpis.customerService.sla}</li>
                    <li><span className="font-semibold">NPS:</span> {partner.confidential.financialAndKpis.kpis.customerService.nps}</li>
                </ul>
            </div>
            <div className="space-y-2 mt-4">
                <p className="font-semibold text-gray-700">Cơ chế quản lý & giám sát:</p>
                <ul className="list-disc list-inside space-y-1 text-gray-600">
                    <li><span className="font-semibold">Dashboard real-time:</span> {partner.confidential.financialAndKpis.kpis.management.realTimeDashboard}</li>
                    <li><span className="font-semibold">Scorecard:</span> {partner.confidential.financialAndKpis.kpis.management.scorecard}</li>
                </ul>
            </div>
        </section>
    </div>
);

const PartnerDetail = ({ t, partner, onBack, onConfidentialRequest, accessStatus }) => (
    <div className="max-w-4xl mx-auto p-8 bg-white rounded-2xl shadow-xl">
      <button onClick={onBack} className="flex items-center text-blue-600 font-semibold mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
          <path fillRule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clipRule="evenodd" />
        </svg>
        {t('backToList')}
      </button>
      <div className="flex items-center mb-6">
        <img src={partner.nppProfile.executiveSummary.logo} alt={`${partner.role} logo`} className="w-32 h-32 rounded-full mr-6 border-4 border-blue-200" />
        <div>
          <h1 className="text-4xl font-bold text-gray-800">{partner.name}</h1>
          <p className="text-xl text-blue-600 font-semibold">{partner.role === 'brand' ? t('roleBrand') : t('roleNPP')}</p>
        </div>
      </div>
      <div className="space-y-6 text-lg">
        {partner.nppProfile ? (
            <NPPDetailProfile t={t} partner={partner} />
        ) : (
            <>
                <div>
                  <h3 className="text-xl font-bold text-gray-700 mb-2">Mô tả</h3>
                  <p className="text-gray-600">{partner.description}</p>
                </div>
                <div>
                  <h3 className="text-xl font-bold text-gray-700 mb-2">Thông tin liên hệ</h3>
                  <p className="text-gray-600">Email: {partner.contact}</p>
                </div>
                <div>
                  <h3 className="text-xl font-bold text-gray-700 mb-2">Thông tin chung</h3>
                  <ul className="list-disc list-inside text-gray-600">
                    <li><span className="font-semibold">{t('address')}:</span> {partner.address}</li>
                    {partner.website && <li><span className="font-semibold">{t('website')}:</span> <a href={partner.website} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">{partner.website}</a></li>}
                    <li><span className="font-semibold">{t('productCategory')}:</span> {partner.productCategory}</li>
                    <li><span className="font-semibold">{t('markets')}:</span> {partner.markets}</li>
                    <li><span className="font-semibold">{t('companySize')}:</span> {partner.companySize}</li>
                    <li><span className="font-semibold">{t('employees')}:</span> {partner.employees}</li>
                    <li><span className="font-semibold">{t('annualRevenue')}:</span> {partner.annualRevenue}</li>
                    <li><span className="font-semibold">{t('marketCoverage')}:</span> {partner.marketCoverage}</li>
                  </ul>
                </div>
                {partner.kpis && (
                  <div>
                    <h3 className="text-xl font-bold text-gray-700 mb-2">{t('kpi')}</h3>
                    {/* Operational KPIs */}
                    {partner.kpis.operation && (
                      <div className="bg-gray-50 p-4 rounded-xl mb-4">
                        <h4 className="font-bold text-blue-700 mb-2">{t('operation')}</h4>
                        <ul className="list-disc list-inside text-gray-600 text-sm space-y-1">
                          <li><span className="font-semibold">{t('storesLast3Months')}:</span> {partner.kpis.operation.storesLast3Months}</li>
                          <li><span className="font-semibold">{t('salesmanRatio')}:</span> {partner.kpis.operation.salesmanRatio}</li>
                          <li><span className="font-semibold">{t('callsPerDay')}:</span> {partner.kpis.operation.callsPerDay}</li>
                          <li><span className="font-semibold">{t('successfulCallRate')}:</span> {partner.kpis.operation.successfulCallRate}</li>
                          <li><span className="font-semibold">{t('ordersPerCall')}:</span> {partner.kpis.operation.ordersPerCall}</li>
                        </ul>
                      </div>
                    )}
                    {/* Trade Marketing KPIs */}
                    {partner.kpis.tradeMarketing && (
                      <div className="bg-gray-50 p-4 rounded-xl mb-4">
                        <h4 className="font-bold text-blue-700 mb-2">{t('tradeMarketing')}</h4>
                        <ul className="list-disc list-inside text-gray-600 text-sm space-y-1">
                          <li><span className="font-semibold">{t('onTimeDelivery')}:</span> {partner.kpis.tradeMarketing.onTimeDelivery}</li>
                          <li><span className="font-semibold">{t('inventoryAccuracy')}:</span> {partner.kpis.tradeMarketing.inventoryAccuracy}</li>
                          <li><span className="font-semibold">{t('promotionsOnTime')}:</span> {partner.kpis.tradeMarketing.promotionsOnTime}</li>
                        </ul>
                      </div>
                    )}
                    {/* Marketing KPIs */}
                    {partner.kpis.marketing && (
                      <div className="bg-gray-50 p-4 rounded-xl mb-4">
                        <h4 className="font-bold text-blue-700 mb-2">{t('marketing')}</h4>
                        <ul className="list-disc list-inside text-gray-600 text-sm space-y-1">
                          <li><span className="font-semibold">{t('salesForceSupport')}:</span> {partner.kpis.marketing.salesForceSupport}</li>
                          <li><span className="font-semibold">{t('brandCampaignParticipation')}:</span> {partner.kpis.marketing.brandCampaignParticipation}</li>
                          <li><span className="font-semibold">{t('digitalFootprint')}:</span> {partner.kpis.marketing.digitalFootprint}</li>
                          <li><span className="font-semibold">{t('socialMediaEngagement')}:</span> {partner.kpis.marketing.socialMediaEngagement}</li>
                          <li><span className="font-semibold">{t('adCampaignROI')}:</span> {partner.kpis.marketing.adCampaignROI}</li>
                        </ul>
                      </div>
                    )}
                    {/* Financial KPIs */}
                    {partner.kpis.financial && (
                      <div className="bg-gray-50 p-4 rounded-xl mb-4">
                        <h4 className="font-bold text-blue-700 mb-2">{t('financial')}</h4>
                        <ul className="list-disc list-inside text-gray-600 text-sm space-y-1">
                          <li><span className="font-semibold">{t('revenueGrowth')}:</span> {partner.kpis.financial.revenueGrowth}</li>
                          <li><span className="font-semibold">{t('profitMargin')}:</span> {partner.kpis.financial.profitMargin}</li>
                          <li><span className="font-semibold">{t('paymentTime')}:</span> {partner.kpis.financial.paymentTime}</li>
                        </ul>
                      </div>
                    )}
                    {/* Reporting System */}
                    {partner.kpis.reporting && (
                      <div className="bg-gray-50 p-4 rounded-xl">
                        <h4 className="font-bold text-blue-700 mb-2">{t('reporting')}</h4>
                        <p className="text-gray-600 text-sm">{partner.kpis.reporting}</p>
                      </div>
                    )}
                  </div>
                )}
            </>
        )}
        
        {partner.confidential && (
          <div className="bg-blue-50 p-6 rounded-2xl border-2 border-blue-200 mt-8">
            <h3 className="text-xl font-bold text-blue-800 mb-4">{t('confidentialInfo')}</h3>
            {accessStatus === 'granted' ? (
              <div className="space-y-4">
                <div className="space-y-2">
                    <h4 className="font-bold text-gray-700">{t('confidentialTerritory')}</h4>
                    <p className="text-gray-600">{partner.confidential.legalCommitment?.cooperationPolicy || 'N/A'}</p>
                </div>
                <div className="space-y-2">
                    <h4 className="font-bold text-gray-700">{t('confidentialPricing')}</h4>
                    <p className="text-gray-600">{partner.confidential.partnershipModel?.costTerms || 'N/A'}</p>
                </div>
                <div className="space-y-2">
                    <h4 className="font-bold text-gray-700">{t('confidentialMOQ')}</h4>
                    <p className="text-gray-600">{partner.confidential.partnershipModel?.moqFulfillment || 'N/A'}</p>
                </div>
                <div className="space-y-2">
                    <h4 className="font-bold text-gray-700">{t('confidentialMarketing')}</h4>
                    <p className="text-gray-600">{partner.confidential.partnershipModel?.marketingSupport || 'N/A'}</p>
                </div>
                <div className="space-y-2">
                    <h4 className="font-bold text-gray-700">{t('confidentialAfterSales')}</h4>
                    <p className="text-gray-600">{partner.confidential.partnershipModel?.afterSalesPolicy || 'N/A'}</p>
                </div>
                <div className="space-y-2">
                    <h4 className="font-bold text-gray-700">{t('confidentialPerformance')}</h4>
                    <p className="text-gray-600">
                      <ul className="list-disc list-inside space-y-1 text-gray-600">
                        <li>Doanh số hàng tháng: {partner.confidential.financialAndKpis?.kpis?.salesCoverage?.monthlySales || 'N/A'}</li>
                        <li>Số điểm bán mới: {partner.confidential.financialAndKpis?.kpis?.salesCoverage?.newOutlets || 'N/A'}</li>
                      </ul>
                    </p>
                </div>
                <div className="space-y-2">
                    <h4 className="font-bold text-gray-700">{t('confidentialMonitoring')}</h4>
                    <p className="text-gray-600">{partner.confidential.financialAndKpis?.kpis?.management?.realTimeDashboard || 'N/A'}</p>
                </div>
                <div className="space-y-2">
                    <h4 className="font-bold text-gray-700">{t('confidentialRisks')}</h4>
                    <p className="text-gray-600">{partner.confidential.legalCommitment?.legalTerms || 'N/A'}</p>
                </div>
                <div className="space-y-2">
                    <h4 className="font-bold text-gray-700">{t('confidentialFinancials')}</h4>
                    <p className="text-gray-600">{partner.confidential.financialAndKpis?.financialStability || 'N/A'}</p>
                </div>
                <div className="space-y-2">
                    <h4 className="font-bold text-gray-700">{t('confidentialLogistics')}</h4>
                    <p className="text-gray-600">{partner.confidential.logistics?.system || 'N/A'}</p>
                </div>
              </div>
            ) : accessStatus === 'pending' ? (
              <p className="text-gray-500 font-semibold text-center py-4">{t('accessPending')}</p>
            ) : (
              <div className="text-center">
                <p className="text-gray-500 mb-4">Để xem thông tin này, bạn cần gửi yêu cầu đến đối tác.</p>
                <button
                  onClick={() => onConfidentialRequest(partner.id)}
                  className="bg-blue-600 text-white font-bold py-3 px-8 rounded-full hover:bg-blue-700 transition-colors duration-200"
                >
                  {t('requestAccessButton')}
                </button>
              </div>
            )}
          </div>
        )}
      </div>
    </div>
);

const ComparisonTable = ({ t, comparisonList, onBackToList }) => {
    const kpiCategories = {
        importCompliance: "KPI về nhập khẩu & tuân thủ",
        logisticsDistribution: "KPI về logistics & phân phối",
        salesCoverage: "KPI về bán hàng & độ phủ",
        marketingBranding: "KPI về marketing & thương hiệu",
        customerService: "KPI về dịch vụ khách hàng & hậu mãi",
        management: "Cơ chế quản lý & giám sát",
    };
    
    const kpiNames = {
        avgCustomsClearance: "Thời gian thông quan trung bình",
        complianceRate: "Tỷ lệ lô hàng đạt chuẩn",
        onTimeDelivery: "Tỷ lệ giao hàng đúng hạn",
        fillRate: "Tỷ lệ fill-rate (đáp ứng đơn hàng)",
        logisticsCostPerRevenue: "Chi phí logistics/doanh thu",
        monthlySales: "Doanh số hàng tháng",
        newOutlets: "Số điểm bán mới",
        marketShare: "Thị phần trong phân khúc mục tiêu",
        activationsCount: "Số activation triển khai",
        coMarketingROI: "ROI từ co-marketing",
        sla: "SLA xử lý khiếu nại",
        nps: "Net Promoter Score (NPS)",
        realTimeDashboard: "Dashboard real-time",
        scorecard: "Scorecard đánh giá định kỳ",
    };

    return (
        <div className="max-w-full overflow-x-auto p-8 bg-white rounded-2xl shadow-xl">
            <h1 className="text-4xl font-bold text-center mb-6 text-blue-800">{t('comparisonTitle')}</h1>
            <button onClick={onBackToList} className="flex items-center text-blue-600 font-semibold mb-6">
              <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clipRule="evenodd" />
              </svg>
              {t('backToList')}
            </button>
            <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Tiêu chí</th>
                            {comparisonList.map(partner => (
                                <th key={partner.id} className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">{partner.name}</th>
                            ))}
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {Object.keys(kpiCategories).map(categoryKey => (
                            <tr key={categoryKey} className="bg-gray-100">
                                <td colSpan={comparisonList.length + 1} className="px-6 py-4 text-sm font-bold text-blue-700 uppercase">{kpiCategories[categoryKey]}</td>
                            </tr>
                        ))}
                        {Object.keys(kpiNames).map(kpiKey => (
                            <tr key={kpiKey}>
                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{kpiNames[kpiKey]}</td>
                                {comparisonList.map(partner => (
                                    <td key={`${partner.id}-${kpiKey}`} className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {partner.confidential?.financialAndKpis?.kpis?.[Object.keys(partner.confidential.financialAndKpis.kpis).find(cat => Object.keys(partner.confidential.financialAndKpis.kpis[cat]).includes(kpiKey))]?.[kpiKey] || 'N/A'}
                                    </td>
                                ))}
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

// Admin Dashboard Component
const AdminDashboard = ({ t, partners, onUpdateStatus }) => {
    const pendingPartners = partners.filter(p => p.status === 'pending');

    return (
        <div className="max-w-4xl mx-auto p-8 bg-white rounded-2xl shadow-xl">
            <h1 className="text-4xl font-bold text-center mb-8 text-blue-800">{t('adminDashboard')}</h1>
            <h2 className="text-2xl font-semibold text-gray-700 mb-4">{t('pendingProfiles')}</h2>
            {pendingPartners.length === 0 ? (
                <p className="text-center text-gray-500">{t('noPendingProfiles')}</p>
            ) : (
                <div className="grid grid-cols-1 gap-6">
                    {pendingPartners.map(partner => (
                        <div key={partner.id} className="bg-gray-50 p-6 rounded-xl shadow-sm border border-gray-200">
                            <div className="flex justify-between items-center mb-4">
                                <div>
                                    <h3 className="text-xl font-bold text-gray-800">{partner.name}</h3>
                                    <p className="text-sm text-blue-600 font-semibold">{partner.role === 'brand' ? t('roleBrand') : t('roleNPP')}</p>
                                </div>
                                <span className="bg-yellow-200 text-yellow-800 text-xs font-semibold px-2.5 py-1 rounded-full">{t('statusPending')}</span>
                            </div>
                            <p className="text-gray-600 mb-4">{partner.description}</p>
                            <div className="flex space-x-2">
                                <button
                                    onClick={() => onUpdateStatus(partner.id, 'approved')}
                                    className="flex-1 bg-green-500 text-white font-bold py-2 px-4 rounded-full hover:bg-green-600 transition-colors duration-200"
                                >
                                    {t('approveButton')}
                                </button>
                                <button
                                    onClick={() => onUpdateStatus(partner.id, 'rejected')}
                                    className="flex-1 bg-red-500 text-white font-bold py-2 px-4 rounded-full hover:bg-red-600 transition-colors duration-200"
                                >
                                    {t('rejectButton')}
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
};

const App = () => {
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [user, setUser] = useState(null);
  const [userRole, setUserRole] = useState(null);
  const [profileExists, setProfileExists] = useState(false);
  const [loading, setLoading] = useState(true);
  const [lang, setLang] = useState('vi');
  const [isLoginModalOpen, setIsLoginModalOpen] = useState(false);
  const [isRegisterModalOpen, setIsRegisterModalOpen] = useState(false);
  const [viewMode, setViewMode] = useState('detail'); // 'list', 'detail', 'comparison', 'admin', 'public', 'profile'
  const [selectedPartner, setSelectedPartner] = useState(null);
  const [requestedAccess, setRequestedAccess] = useState({});
  const [comparisonList, setComparisonList] = useState([]);
  const [allPartners, setAllPartners] = useState([]);

  const t = (key) => translations[lang][key];

  useEffect(() => {
    const app = initializeApp(firebaseConfig);
    const authInstance = getAuth(app);
    const dbInstance = getFirestore(app);
    setAuth(authInstance);
    setDb(dbInstance);

    const handleAuth = async () => {
      try {
        if (initialAuthToken) {
          await signInWithCustomToken(authInstance, initialAuthToken);
        } else {
          await signInAnonymously(authInstance);
        }
      } catch (error) {
        console.error("Firebase authentication error:", error);
      }
    };
    
    // Giả lập người dùng đăng nhập
    const mockUser = {
        uid: 'demo-brand-12345',
        isAnonymous: false,
    };
    const mockUserRole = 'brand'; // Giả lập bạn là một Brand
    
    // Giả lập hồ sơ đã tồn tại
    setUser(mockUser);
    setUserRole(mockUserRole);
    setProfileExists(true);
    setLoading(false);
    const partners = getMockPartnersData();
    setAllPartners(partners);
    setSelectedPartner(partners.find(p => p.id === 'npp1'));
    
    handleAuth();
  }, []);

  const handleEmailLogin = async (email, password) => {
    await signInWithEmailAndPassword(auth, email, password);
    setIsLoginModalOpen(false);
  };

  const handleEmailRegister = async (email, password, role) => {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;
    
    const safeAppId = appId.replace(/\//g, '_').replace(/\./g, '_');
    await setDoc(doc(db, 'artifacts', safeAppId, 'users', user.uid, 'profile', 'main'), {
      role: role,
      uid: user.uid,
      isProfileComplete: false,
    });
    setIsRegisterModalOpen(false);
  };

  const handleLogout = async () => {
    try {
      await signOut(auth);
      await signInAnonymously(auth);
    } catch (error) {
      console.error("Logout error:", error);
    }
  };
  
  const handleSaveProfile = async (profileData) => {
      const safeAppId = appId.replace(/\//g, '_').replace(/\./g, '_');
      const userDocRef = doc(db, 'artifacts', safeAppId, 'users', user.uid);
      await setDoc(userDocRef, { profile: { ...profileData, isProfileComplete: true } }, { merge: true });
      setProfileExists(true);
  };

  const handleSelectPartner = (partner) => {
    setSelectedPartner(partner);
    setViewMode('detail');
  };

  const handleBackToList = () => {
    setViewMode('list');
    setSelectedPartner(null);
  };

  const handleStartComparison = () => {
    setViewMode('comparison');
  };
  
  const handleConfidentialRequest = (partnerId) => {
      // Mô phỏng việc gửi yêu cầu
      setRequestedAccess(prev => ({ ...prev, [partnerId]: 'pending' }));
      console.log(`Đã gửi yêu cầu quyền truy cập cho đối tác: ${partnerId}`);
      
      // Giả lập Admin phê duyệt sau 3 giây
      setTimeout(() => {
          setRequestedAccess(prev => ({ ...prev, [partnerId]: 'granted' }));
          console.log(`Yêu cầu quyền truy cập đã được phê duyệt cho đối tác: ${partnerId}`);
      }, 3000);
  };

  const handleSelectForComparison = (partner, clear = false) => {
    if (clear) {
      setComparisonList([]);
      return;
    }
    setComparisonList(prevList => {
      const isExist = prevList.some(p => p.id === partner.id);
      if (isExist) {
        return prevList.filter(p => p.id !== partner.id);
      } else {
        return [...prevList, partner];
      }
    });
  };

  const handleUpdatePartnerStatus = (partnerId, newStatus) => {
    setAllPartners(prevPartners => prevPartners.map(p => {
        if (p.id === partnerId) {
            return { ...p, status: newStatus };
        }
        return p;
    }));
  };

  const BrandNPPPlaceholderCard = ({ role, name, description, imgUrl }) => (
    <div className="bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2">
      <div className="flex items-center mb-4">
        <img src={imgUrl} alt={`${role} logo`} className="w-16 h-16 rounded-full mr-4" />
        <div>
          <h3 className="text-xl font-bold text-gray-800">{name}</h3>
          <p className="text-sm text-blue-600 font-semibold">{role}</p>
        </div>
      </div>
      <p className="text-gray-600 mb-4">{description}</p>
      <button onClick={() => setIsLoginModalOpen(true)} className="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-700 transition-colors duration-200">
        {t('loginButton')}
      </button>
    </div>
  );

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-100">
        <div className="text-center text-xl font-semibold text-gray-700">Đang tải...</div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-100 font-sans text-gray-800">
      {/* Header */}
      <header className="bg-white shadow-sm py-4">
        <div className="container mx-auto px-6 flex justify-between items-center">
          <div className="text-2xl font-bold text-blue-600">{t('platformTitle')}</div>
          <div className="flex items-center space-x-4">
            <div className="flex items-center space-x-2 text-sm font-medium text-gray-600">
              <span>{t('language')}</span>
              <select
                value={lang}
                onChange={(e) => setLang(e.target.value)}
                className="rounded-md border border-gray-300 p-1"
              >
                <option value="vi">{t('vietnamese')}</option>
                <option value="en">{t('english')}</option>
              </select>
            </div>
            {user && !user.isAnonymous ? (
              <button
                onClick={handleLogout}
                className="bg-red-500 text-white py-2 px-4 rounded-full text-sm font-bold hover:bg-red-600 transition-colors duration-200"
              >
                {t('logoutButton')}
              </button>
            ) : (
              <button
                onClick={() => setIsLoginModalOpen(true)}
                className="bg-blue-600 text-white py-2 px-4 rounded-full text-sm font-bold hover:bg-blue-700 transition-colors duration-200"
              >
                {t('loginButton')}
              </button>
            )}
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main className="container mx-auto px-6 py-12">
        {user && !user.isAnonymous ? (
          userRole === 'admin' ? (
            <AdminDashboard
                t={t}
                partners={allPartners}
                onUpdateStatus={handleUpdatePartnerStatus}
            />
          ) : !profileExists ? (
            /* Profile Form View */
            <ProfileForm 
                t={t} 
                db={db} 
                user={user} 
                userRole={userRole} 
                onSave={handleSaveProfile} 
            />
          ) : (
            /* Authenticated View */
            viewMode === 'list' ? (
                <PartnerList 
                  t={t} 
                  db={db} 
                  user={user} 
                  userRole={userRole} 
                  onSelectPartner={handleSelectPartner}
                  onSelectForComparison={handleSelectForComparison}
                  comparisonList={comparisonList}
                  onStartComparison={handleStartComparison}
                />
            ) : viewMode === 'detail' ? (
                <PartnerDetail 
                  t={t} 
                  partner={selectedPartner} 
                  onBack={handleBackToList} 
                  onConfidentialRequest={handleConfidentialRequest}
                  accessStatus={requestedAccess[selectedPartner?.id]}
                />
            ) : (
              <ComparisonTable 
                t={t} 
                comparisonList={comparisonList}
                onBackToList={() => setViewMode('list')}
              />
            )
          )
        ) : (
          /* Public View */
          <div className="text-center">
            <h1 className="text-5xl font-extrabold text-blue-800 leading-tight mb-4">{t('platformTitle')}</h1>
            <p className="text-xl text-gray-600 max-w-3xl mx-auto mb-12">{t('platformSubtitle')}</p>
            <div className="grid md:grid-cols-2 gap-8 max-w-5xl mx-auto">
              {/* Brand Section */}
              <div className="bg-white p-8 rounded-2xl shadow-xl">
                <h2 className="text-3xl font-bold text-blue-600 mb-4">{t('homeBrandTitle')}</h2>
                <p className="text-gray-700 text-lg mb-6">{t('homeBrandDescription')}</p>
                <div className="flex justify-center">
                  <button onClick={() => setIsLoginModalOpen(true)} className="bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-blue-700 transition-colors duration-200 transform hover:-translate-y-1">
                    {t('loginButton')}
                  </button>
                </div>
              </div>
              {/* NPP Section */}
              <div className="bg-white p-8 rounded-2xl shadow-xl">
                <h2 className="text-3xl font-bold text-blue-600 mb-4">{t('homeNPPTitle')}</h2>
                <p className="text-gray-700 text-lg mb-6">{t('homeNPPDescription')}</p>
                <div className="flex justify-center">
                  <button onClick={() => setIsLoginModalOpen(true)} className="bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-blue-700 transition-colors duration-200 transform hover:-translate-y-1">
                    {t('loginButton')}
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}
      </main>
      {/* Modals */}
      {isLoginModalOpen && (
        <LoginModal
          t={t}
          onLogin={handleEmailLogin}
          onClose={() => setIsLoginModalOpen(false)}
          onSwitchToRegister={() => {
            setIsLoginModalOpen(false);
            setIsRegisterModalOpen(true);
          }}
        />
      )}
      {isRegisterModalOpen && (
        <RegisterModal
          t={t}
          onRegister={handleEmailRegister}
          onClose={() => setIsRegisterModalOpen(false)}
          onSwitchToLogin={() => {
            setIsRegisterModalOpen(false);
            setIsLoginModalOpen(true);
          }}
        />
      )}
      {/* Tailwind CDN */}
      <script src="https://cdn.tailwindcss.com"></script>
    </div>
  );
};

export default App;
